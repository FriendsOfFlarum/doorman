(()=>{var o={n:t=>{var e=t&&t.__esModule?()=>t.default:()=>t;return o.d(e,{a:e}),e},d:(t,e)=>{for(var a in e)o.o(e,a)&&!o.o(t,a)&&Object.defineProperty(t,a,{enumerable:!0,get:e[a]})},o:(o,t)=>Object.prototype.hasOwnProperty.call(o,t),r:o=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(o,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(o,"__esModule",{value:!0})}},t={};(()=>{"use strict";o.r(t);const e=flarum.core.compat["admin/app"];var a=o.n(e);function n(o,t){return n=Object.setPrototypeOf||function(o,t){return o.__proto__=t,o},n(o,t)}function r(o,t){o.prototype=Object.create(t.prototype),o.prototype.constructor=o,n(o,t)}const s=flarum.core.compat["common/Model"];var i=o.n(s);const l=flarum.core.compat["common/utils/mixin"];var d=function(o){function t(){return o.apply(this,arguments)||this}return r(t,o),t.prototype.apiEndpoint=function(){return"/fof/doorkeys"+(this.exists?"/"+this.data.id:"")},t}(o.n(l)()(i(),{key:i().attribute("key"),groupId:i().attribute("groupId"),maxUses:i().attribute("maxUses"),uses:i().attribute("uses"),activates:i().attribute("activates")}));const c=flarum.core.compat["admin/components/ExtensionPage"];var u=o.n(c);const p=flarum.core.compat["common/components/LoadingIndicator"];var f=o.n(p);const y=flarum.core.compat["common/Component"];var h=o.n(y);const k=flarum.core.compat["common/components/Button"];var g=o.n(k);const v=flarum.core.compat["common/components/Badge"];var b=o.n(v);const w=flarum.core.compat["common/components/Select"];var x=o.n(w);const N=flarum.core.compat["common/components/Switch"];var D=o.n(N);const I=flarum.core.compat["common/utils/Stream"];var B=o.n(I);const U=flarum.core.compat["common/components/Alert"];var S=o.n(U);const C=flarum.core.compat["common/components/Modal"];var _=function(o){function t(){return o.apply(this,arguments)||this}r(t,o);var e=t.prototype;return e.oninit=function(t){o.prototype.oninit.call(this,t),this.emails=[],this.doorkey=this.attrs.doorkey,this.success=!1},e.className=function(){return"InviteCodeModal Modal--small"},e.title=function(){return a().translator.trans("fof-doorman.admin.modal.title")},e.oncreate=function(t){var e=this;o.prototype.oncreate.call(this,t),$("#EmailInput").off().on("keydown",(function(o){13!==o.keyCode&&188!==o.keyCode&&32!==o.keyCode||(o.preventDefault(),e.addEmails())}))},e.onremove=function(t){o.prototype.onremove.call(this,t),a().alerts.dismiss(this.alert)},e.content=function(){var o=this;return m("div",{className:"Modal-body"},m("h3",null,a().translator.trans("fof-doorman.admin.modal.group",{group:a().store.getById("groups",this.doorkey.groupId()).nameSingular()})),m("div",{className:"helpText"},a().translator.trans("fof-doorman.admin.modal.help")),m("div",{className:"Form Form--centered"},m("div",{className:"Form-group"},m("input",{type:"text",name:"text",id:"EmailInput",className:"FormControl",placeholder:a().translator.trans("fof-doorman.admin.modal.placeholder"),disabled:this.loading})),m("div",{className:"Form-group"},m("ul",null,this.emails.map((function(t,e){return m("li",{className:"emailListItem"},m("p",null,t),g().component({className:"Button",loading:o.loading,icon:"fas fa-times",onclick:o.removeEmail.bind(o,e)}))})))),m("div",{className:"Form-group"},g().component({className:"Button Button--primary Button--block",loading:this.loading,onclick:this.send.bind(this),disabled:0===this.emails.length},a().translator.trans("fof-doorman.admin.modal.send")))))},e.addEmails=function(){var o=this;a().alerts.dismiss(this.alert),m.redraw(),this.badEmails=[],$("#EmailInput").val().split(/[ ,]+/).map((function(t){if(!o.emails.includes(t)){var e=o.doorkey.maxUses(),n=o.doorkey.uses();e>0&&n+o.emails.length+1>e?(o.alert=a().alerts.show(S(),{type:"error"},a().translator.trans("fof-doorman.admin.modal.max_use_conflict")),m.redraw()):o.validateEmail(t)?(o.emails.push(t),$("#EmailInput").val(""),m.redraw()):(o.badEmails.push(t),o.alert=a().alerts.show(S(),{type:"error"},a().translator.trans("fof-doorman.admin.modal.invalid_emails",{emails:o.badEmails.join(", ")})),m.redraw())}}))},e.validateEmail=function(o){return/^(([^<>()\[\]\\.,;:\s@"]+(\.[^<>()\[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/.test(String(o).toLowerCase())},e.removeEmail=function(o){this.emails.splice(o,1)},e.send=function(o){var t=this;o.preventDefault(),a().alerts.dismiss(this.alert),this.loading=!0,a().request({method:"POST",url:a().forum.attribute("apiUrl")+"/fof/doorkeys/invites",body:{emails:this.emails,doorkeyId:this.doorkey.data.id}}).then((function(){a().modal.close(),t.alert=a().alerts.show(S(),{type:"success"},a().translator.trans("fof-doorman.admin.modal.success"))}))},t}(o.n(C)()),E=function(o){function t(){return o.apply(this,arguments)||this}r(t,o);var e=t.prototype;return e.oninit=function(t){o.prototype.oninit.call(this,t),this.doorkey=this.attrs.doorkey,this.key=B()(this.doorkey.key()),this.groupId=B()(this.doorkey.groupId()||3),this.maxUses=B()(this.doorkey.maxUses()||"0"),this.activates=B()(!!this.doorkey.activates())},e.view=function(){var o=this.doorkey.maxUses(),t=this.doorkey.uses(),e=o-t,n="fof-doorkey-"+this.doorkey.id();return m("tr",{className:"DoormanSettingsListItem"},m("td",null,m("input",{className:"FormControl Doorkey-key",type:"text",disabled:!0,value:this.key(),placeholder:a().translator.trans("fof-doorman.admin.page.doorkey.key")})),m("td",null,x().component({options:this.getGroupsForInput(),className:"Doorkey-select",onchange:this.groupId,value:this.groupId()})),m("td",null,m("input",{className:"FormControl Doorkey-maxUses",bidi:this.maxUses,min:"0",type:"number",form:n,placeholder:a().translator.trans("fof-doorman.admin.page.doorkey.max_uses")})),m("td",null,D().component({state:this.activates(),onchange:this.activates,className:"Doorkey-switch"})),m("td",null,g().component({type:"button",className:"Button Button--icon Doorkey-button",icon:"fa fa-envelope fa-fw",onclick:this.showModal.bind(this)})),m("td",null,m("form",{id:n},m("div",{className:"ButtonGroup Doorkey-button"},g().component({type:"submit",className:"Button Button--icon",icon:"fas "+(this.loading?"fa-circle-notch fa-spin":"fa-save")+" fa-fw",onclick:this.save.bind(this),disabled:this.loading||this.loadingDelete}),g().component({type:"button",className:"Button Button--danger Button--icon",icon:"fas "+(this.loadingDelete?"fa-circle-notch fa-spin":"fa-times")+" fa-fw",onclick:this.delete.bind(this),disabled:this.loadingDelete})))),m("td",null,o>0&&t>=o?b().component({className:"Button--icon Doorkey-badge",icon:"fas fa-user-slash",label:a().translator.trans("fof-doorman.admin.page.doorkey.warning")}):m("b",null,e<0?a().translator.trans("fof-doorman.admin.page.doorkey.total_uses",{totalUses:t}):a().translator.trans("fof-doorman.admin.page.doorkey.used_times",{remaining:e}))))},e.showModal=function(){a().modal.show(_,{doorkey:this.doorkey})},e.getGroupsForInput=function(){var o=[];return a().store.all("groups").map((function(t){"Guest"!==t.nameSingular()&&(o[t.id()]=t.nameSingular())})),o},e.save=function(o){var t=this;return null==o||null==o.preventDefault||o.preventDefault(),this.loading=!0,this.doorkey.save({groupId:this.groupId(),maxUses:this.maxUses(),activates:this.activates()}).finally((function(){t.loading=!1,m.redraw()}))},e.delete=function(){var o=this;this.loadingDelete=!0,this.doorkey.delete().finally((function(){o.loadingDelete=!1,m.redraw()}))},t}(h());const F=flarum.core.compat["common/utils/withAttr"];var M=o.n(F),P=function(o){function t(){return o.apply(this,arguments)||this}r(t,o);var e=t.prototype;return e.oninit=function(t){o.prototype.oninit.call(this,t),this.loadingKeys=!0,this.isOptional=a().data.settings["fof-doorman.allowPublic"],this.doorkey={key:B()(this.generateRandomKey()),groupId:B()(3),maxUses:B()(10),activates:B()(!1)}},e.oncreate=function(t){var e=this;o.prototype.oncreate.call(this,t),a().store.find("fof/doorkeys").then((function(){e.loadingKeys=!1,m.redraw()}))},e.content=function(){var o=a().store.all("doorkeys");return m("div",{className:"container Doorkey-container"},m("div",{className:"Doorkeys-title"},m("h2",null,a().translator.trans("fof-doorman.admin.page.doorkey.title")),m("p",{className:"helpText"},a().translator.trans("fof-doorman.admin.page.doorkey.help.key")," ",m("br",null),a().translator.trans("fof-doorman.admin.page.doorkey.help.group")," ",m("br",null),a().translator.trans("fof-doorman.admin.page.doorkey.help.max")," ",m("br",null),a().translator.trans("fof-doorman.admin.page.doorkey.help.activates")," ",m("br",null))),this.loadingKeys?m(f(),null):m("table",{className:"Table"},m("thead",null,m("tr",{className:"Doorkeys-fieldLabels"},m("th",null,a().translator.trans("fof-doorman.admin.page.doorkey.heading.key")),m("th",null,a().translator.trans("fof-doorman.admin.page.doorkey.heading.group")),m("th",null,a().translator.trans("fof-doorman.admin.page.doorkey.heading.max_uses")),m("th",null,a().translator.trans("fof-doorman.admin.page.doorkey.heading.activate")))),m("tbody",null,o.map((function(t){return m(E,{doorkey:t,doorkeys:o})}))),m("tfoot",null,m("tr",{className:"Doorkeys-new"},m("td",null,m("input",{className:"FormControl Doorkey-key",type:"text",value:this.doorkey.key(),placeholder:a().translator.trans("fof-doorman.admin.page.doorkey.key"),oninput:M()("value",this.doorkey.key),form:"fof-doorkey-new"})),m("td",null,x().component({options:this.getGroupsForInput(),className:"Doorkey-select",onchange:this.doorkey.groupId,value:this.doorkey.groupId()})),m("td",null,m("input",{className:"FormControl Doorkey-maxUses",value:this.doorkey.maxUses(),type:"number",placeholder:a().translator.trans("fof-doorman.admin.page.doorkey.max_uses"),oninput:M()("value",this.doorkey.maxUses),min:"0",form:"fof-doorkey-new"})),m("td",null,D().component({state:this.doorkey.activates()||!1,onchange:this.doorkey.activates,className:"Doorkey-switch"})),m("td",null,m("form",{id:"fof-doorkey-new"},g().component({type:"submit",className:"Button Button--icon Doorkey-button",icon:"fa "+(this.loadingCreate?"fa-circle-notch fa-spin":"fa-plus")+" fa-fw",onclick:this.createDoorkey.bind(this),disabled:this.loadingCreate})))))),m("div",{className:"Doorkey-allowPublic"},m("h2",null,a().translator.trans("fof-doorman.admin.page.doorkey.allow-public.title")),this.buildSettingComponent({type:"boolean",setting:"fof-doorman.allowPublic",label:a().translator.trans("fof-doorman.admin.page.doorkey.allow-public.switch-label")}),this.submitButton()))},e.getGroupsForInput=function(){var o=[];return a().store.all("groups").map((function(t){"Guest"!==t.nameSingular()&&(o[t.id()]=t.nameSingular())})),o},e.generateRandomKey=function(){return Array(9).join((Math.random().toString(36)+"00000000000000000").slice(2,18)).slice(0,8)},e.createDoorkey=function(o){var t=this;null==o||null==o.preventDefault||o.preventDefault(),this.loadingCreate=!0,a().store.createRecord("doorkeys").save({key:this.doorkey.key(),groupId:this.doorkey.groupId(),maxUses:this.doorkey.maxUses(),activates:this.doorkey.activates()}).then((function(){t.doorkey.key(t.generateRandomKey()),t.doorkey.groupId(3),t.doorkey.maxUses(10),t.doorkey.activates("")})).finally((function(){t.loadingCreate=!1,m.redraw()}))},t}(u());a().initializers.add("fof-doorman",(function(){a().store.models.doorkeys=d,a().extensionData.for("fof-doorman").registerPage(P)}))})(),module.exports=t})();
//# sourceMappingURL=admin.js.map